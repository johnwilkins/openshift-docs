// This is included in the following assemblies:
//
// installing_bare_metal_ipi/ipi-install-installation-workflow.adoc

:_content-type: PROCEDURE
[id="configuring-host-network-interfaces-in-the-install-config-yaml-file_{context}"]
= (Optional) Configuring host network interfaces

Before installation, you can set the `networkConfig` configuration setting in the `install-config.yaml` file to configure host network interfaces using NMState.

The most common use case for this functionality is to specify a static IP address on the `baremetal` network, but you can also configure other networks such as a storage network. This functionality will also support other NMState features such as VLAN, VXLAN, bridges, bonds, routes, MTU, and DNS resolver settings.

.Prequisites

* Configure a `PTR` DNS record with a valid hostname for each node with a static IP address.
* Install `nmstate`.

.Procedure

. Optional. Consider testing the NMState syntax with `nmstatectl gc` before including it in the `install-config.yaml` file, because the installer will not check the NMState YAML syntax. Errors in the YAML syntax might result in a failure to apply the network configuration. Additionally, maintaining the validated YAML syntax is useful when applying changes using Kubernetes NMState after deployment or when expanding the cluster.

.. Create an NMState YAML file:
+
[source,yaml]
----
interfaces:
- name: <NIC1_name>
  type: ethernet
  state: up
  ipv4:
    address:
    - ip: <IP_address>
      prefix-length: 24
    enabled: true
dns-resolver:
  config:
    server:
    - <DNS_IP_address>
routes:
  config:
  - destination: 0.0.0.0/0
    next-hop-address: <next_hop_IP_address>
    next-hop-interface: <next_hop_NIC1_name>
----
+
Replace `<NIC1_name>`, `<IP_address>`, `<DNS_IP_address>`, `<next_hop_IP_address>` and `<next_hop_NIC1_name>` with appropriate values.

.. Test the configuration file by running the following command:
+
[source,terminal]
----
$ nmstatectl gc <networkConfig-configuration-file>
----

. To use the `networkConfig` configuration setting, add the `NMState` configuration within `install-config.yaml`, as shown in the following example:
+
[source,terminal]
----
    hosts:
      - name: openshift-master-0
        role: master
        bmc:
          address: redfish+http://<out_of_band_ip>/redfish/v1/Systems/
          username: <user>
          password: <password>
          disableCertificateVerification: null
        bootMACAddress: <NIC1_mac_address>
        bootMode: UEFI
        rootDeviceHints:
          deviceName: "/dev/sda"
        networkConfig: <1>
          interfaces:
          - name: <NIC1_name>
            type: ethernet
            state: up
            ipv4:
              address:
              - ip: <IP_address>
                prefix-length: 24
              enabled: true
          dns-resolver:
            config:
              server:
              - <DNS_IP_address>
          routes:
            config:
            - destination: 0.0.0.0/0
              next-hop-address: <next_hop_IP_address>
              next-hop-interface: <next_hop_NIC1_name>
----
<1> Add NMState YAML syntax to configure host interfaces.
+
[IMPORTANT]
====
Once deployed, you cannot modify the `networkConfig` configuration setting of `install-config.yaml` file to make changes to the host network interface. Use the Kubernetes NMState Operator to make changes to the host network interface after deployment.
====

. Optional: In the case of deploying {product-title} without a DHCP server on the `baremetal` network, use the following procedure to configure a static IP address for the bootstrap VM using Ignition:

.. Create the `bootstrap_config.sh` file:
+
[source,terminal]
----
$ cat bootstrap_config.sh
#!/bin/bash
BOOTSTRAP_CONFIG="[connection]
type=ethernet
interface-name=<interface_name>
[ethernet]
[ipv4]
method=manual
addresses=<ip_address>/<CIDR>
gateway=<gateway_IP_address>
dns=<dns_IP_address>"
cat > bootstrap_network_config.ign << EOF
{
  "path": "/etc/NetworkManager/system-connections/<interface_name>.nmconnection",
  "mode": 384,
  "contents": {
    "source": "data:text/plain;charset=utf-8;base64,$(echo "${BOOTSTRAP_CONFIG}" | base64 -w 0)"
  }
}
EOF
----
+
Replace `<interface_name>` with the name of the NIC. Replace `<ip_address>` and `<CIDR>` with the IP address and CIDR of the address range. Replace `<gateway_IP_address>` with the IP address of
the gateway on the `baremetal` network. Replace `<dns_IP_address>` with the IP address of the DNS server on the `baremetal` network. Replace `<interface_name>` with the name of the interface.

.. Make the `bootstrap_config.sh` file executable:
+
[source,terminal]
----
$ chmod 755 bootstrap_config.sh
----

.. Run the `bootstrap_config.sh` script to create the `bootstrap_network_config.ign` file:
+
[source,terminal]
----
$ ./bootstrap_config.sh
----

.. Optional: Create a backup of the original `bootstrap.ign` file:
+
[source,terminal]
----
$ mv clusterconfigs/bootstrap.ign clusterconfigs/bootstrap.ign.orig
----

.. Inject the `bootstrap_network_config.ign` file into the `bootstrap.ign` file:
+
[source,terminal]
----
$ jq '.storage.files += $input' clusterconfigs/bootstrap.ign.orig --slurpfile input bootstrap_network_config.ign > clusterconfigs/bootstrap.ign
----
